# 유저플로우 설계 문서 (MVP)

**프로젝트:** 대학교 사내 데이터 시각화 대시보드 MVP
**작성일:** 2025년 11월 2일
**버전:** 2.0 (MVP 최적화)
**작성자:** Userflow Writer Agent

---

## 문서 개요

본 문서는 **MVP 범위**에 맞춘 핵심 유저플로우만 정의합니다. 각 플로우는 **입력(사용자 액션) → 처리(시스템 로직) → 출력(피드백/결과)** 구조로 작성되었으며, 첫 베타테스트에 필요한 최소한의 기능에 집중합니다.

**MVP 핵심 원칙 (CTO Mandate):**
- 빠른 개발 iteration을 위한 간결한 구조
- 오버엔지니어링 배제 - 당장 필요한 기능만 구현
- 가장 단순한 인프라 접근 방식
- 비동기 백그라운드 처리로 Non-blocking UI 확보

**우선순위 태그:**
- `[P0-MVP]`: 첫 베타테스트 필수
- `[P1-MVP]`: 중요하지만 간소화 가능
- `[POST-MVP]`: 추후 고도화 단계에서 구현

---

## 목차

1. [사용자 역할 정의](#1-사용자-역할-정의) `[P0-MVP]`
2. [관리자 데이터 업로드 플로우](#2-관리자-데이터-업로드-플로우) `[P0-MVP]`
3. [메인 대시보드 조회 플로우](#3-메인-대시보드-조회-플로우) `[P0-MVP]`
4. [대시보드 필터링 플로우](#4-대시보드-필터링-플로우) `[P0-MVP]`
5. [차트 인터랙션 플로우](#5-차트-인터랙션-플로우) `[P1-MVP]` (기본 Tooltip만)
6. [데이터 갱신 플로우](#6-데이터-갱신-플로우) `[P1-MVP]` (수동만)
7. [에러 처리 플로우](#7-에러-처리-플로우) `[P0-MVP]` (핵심만)
8. [필수 엣지케이스](#8-필수-엣지케이스) `[P1-MVP]` (4개만)

---

## 1. 사용자 역할 정의

### 1.1 관리자 (Admin User)

**특성:**
- 데이터 업로드 페이지 접근 권한 보유 (하드코딩된 API Key 또는 환경 변수 기반)
- Ecount 시스템에서 추출한 4가지 CSV/Excel 파일 업로드 책임
- 업로드 후 데이터 정확성 검증 수행
- 기술적 숙련도: 중급 (파일 형식 이해 및 기본 트러블슈팅 가능)

**주요 목표:**
- 데이터 파일을 신속하고 효율적으로 업로드
- 데이터 수집(Ingestion) 성공 여부 확인
- 업데이트된 데이터가 대시보드에 정확히 반영되었는지 검증

### 1.2 내부 직원 (Internal Staff / Viewer)

**특성:**
- 모든 대학 직원에게 대시보드 조회 권한 부여
- 업로드 권한 없음 (읽기 전용)
- 주로 시각화된 데이터를 기반으로 의사결정 수행

**주요 목표:**
- 핵심 성과 지표를 한눈에 빠르게 파악
- 학과, 기간 등 다양한 기준으로 데이터 필터링
- 직관적인 차트를 통해 추세와 패턴 이해

---

## 2. 관리자 데이터 업로드 플로우

### 플로우 개요
관리자가 Ecount 시스템에서 추출한 최신 데이터를 시스템에 업로드하여 대시보드에 반영하는 전체 과정

### 진입점
- `/admin/upload` URL 직접 입력 (URL 난독화 전략)
- 메인 대시보드에서 "데이터 업로드" 버튼 클릭 (관리자 모드 활성화 시)

---

### 2.1 관리자 페이지 접근 및 인증

#### 입력 (User Input)
- 브라우저에서 데이터 업로드 페이지 URL 접근
- (선택적) UI에서 하드코딩된 API Key 입력 프롬프트 응답

#### 처리 (System Processing)

**단계 1: 프런트엔드 접근 제어**
- React 앱에서 `process.env.ADMIN_MODE === 'true'` 검증 또는 간단한 문자열 토큰 확인
- 권한 없음 감지 시 메인 대시보드로 자동 리디렉션

**단계 2: 페이지 렌더링**
- 권한 확인 성공 시 데이터 업로드 인터페이스 렌더링
- 4가지 파일 타입별 업로드 영역 표시:
  - 연구비 집행 데이터 (`research_project_data.csv`)
  - 학생 명단 (`student_roster.csv`)
  - 논문 목록 (`publication_list.csv`)
  - 학과 KPI (`department_kpi.csv`)
- 각 영역에 드래그앤드롭 기능 또는 파일 선택 버튼 제공

#### 출력 (User Feedback)
- **성공 시:**
  - 파일 업로드 UI 표시
  - 각 파일 타입별 업로드 상태 표시 영역
  - 지원 파일 형식 및 최대 크기 안내 메시지 표시

- **실패 시 (권한 없음):**
  - 메인 대시보드로 자동 리디렉션
  - 토스트 알림: "관리자 권한이 필요합니다. 접근이 거부되었습니다."
  - 브라우저 콘솔에 접근 거부 로그 기록

#### 엣지케이스
- **환경 변수 미설정:** 모든 사용자가 업로드 페이지 접근 불가 → 시스템 관리자에게 설정 요청 안내 표시
- **잘못된 URL 경로:** 404 페이지 표시 또는 메인 대시보드로 리디렉션
- **API Key 만료/변경:** "인증 정보가 유효하지 않습니다. 관리자에게 문의하세요." 에러 메시지 표시

---

### 2.2 파일 선택 및 클라이언트 검증

#### 입력 (User Input)
- 각 데이터 타입에 해당하는 CSV/Excel 파일 선택
- 파일 선택 방식:
  - 파일 선택 다이얼로그를 통한 선택
  - 드래그앤드롭으로 업로드 영역에 파일 투입

#### 처리 (System Processing)

**단계 1: 프런트엔드 파일 검증**
- 파일 확장자 검증: `.csv`, `.xlsx`, `.xls`만 허용
- 파일 크기 검증: 최대 10MB 제한
- 파일명 패턴 검증 (선택적): 예상되는 파일명과 매칭 여부 확인

**단계 2: UI 상태 업데이트**
- 선택된 파일 정보 표시:
  - 파일명
  - 파일 크기 (MB 단위)
  - 파일 타입 (CSV/Excel)
- 업로드 버튼 활성화 조건 확인:
  - 최소 1개 이상의 파일이 선택됨
  - 선택된 모든 파일이 검증 통과

**단계 3: `[POST-MVP]` 파일 프리뷰**
- MVP에서는 생략

#### 출력 (User Feedback)
- **성공 시:**
  - 선택된 파일 목록 카드 형식으로 표시
  - 각 파일 옆에 "준비됨" 상태 아이콘
  - "업로드 시작" 버튼 활성화 (파란색 강조)

- **실패 시:**
  - **확장자 불일치:** "지원되지 않는 파일 형식입니다. CSV 또는 Excel 파일(.csv, .xlsx, .xls)을 선택하세요." 경고 메시지
  - **크기 초과:** "파일 크기가 10MB를 초과합니다. (현재: XX.X MB) 파일을 분할하거나 데이터를 줄여주세요." 경고 메시지
  - **파일 읽기 오류:** "파일을 읽을 수 없습니다. 파일이 손상되었거나 접근 권한이 없을 수 있습니다." 경고 메시지

#### 엣지케이스
- **동일 파일 중복 선택:** 최신 선택 파일로 자동 교체, "기존 파일이 교체됩니다" 경고 표시
- **비표준 인코딩 파일 (EUC-KR, CP949 등):** UTF-8, EUC-KR, CP949 순서로 자동 감지 및 변환 시도
- **빈 파일 (0 byte):** 선택 시점에서 감지 → "빈 파일입니다. 데이터가 포함된 파일을 선택하세요." 경고
- **숨겨진 행/컬럼이 있는 Excel 파일:** Pandas에서 자동으로 숨겨진 데이터 포함하여 파싱

---

### 2.3 파일 업로드 요청 및 백그라운드 처리 시작

#### 입력 (User Input)
- "업로드 시작" 버튼 클릭
- 선택된 파일 1~4개 (각 데이터 타입별)

#### 처리 (System Processing)

**단계 1: 프런트엔드 요청 준비**
- FormData 객체 생성
- 각 파일 및 메타데이터 추가:
  - 파일 바이너리 데이터
  - 파일 타입 정보 (research_funding, students, publications, kpi)
  - 업로드 타임스탬프
- 요청 헤더에 하드코딩된 API Key 포함: `X-Admin-Key: <키값>`
- 업로드 진행 상태 UI 표시:
  - 각 파일별 프로그레스 바 (0% 상태)
  - "업로드 중..." 로딩 스피너
  - 업로드 버튼 비활성화

**단계 2: HTTP 요청 전송**
- `POST /api/upload/` 엔드포인트 호출
- Content-Type: `multipart/form-data`
- 타임아웃 설정: 60초 (대용량 파일 대응)

**단계 3: DRF View 요청 수신 및 검증**
- API Key 검증 (DRF 미들웨어 또는 View 레벨)
- Request Serializer를 통한 파일 형식 재검증
- 파일을 임시 저장 경로에 저장 (예: `/tmp/upload_{job_id}/`)

**단계 4: 비동기 백그라운드 작업 등록**
- Python `threading.Thread` 또는 간단한 백그라운드 태스크 큐에 파싱 작업 등록
- 고유한 작업 ID (`job_id`) 생성 (UUID 형식)
- 작업 상태 초기화: `{"status": "processing", "progress": 0}`
- 즉시 HTTP 202 Accepted 응답 반환 (Non-blocking)

#### 출력 (User Feedback)
- **성공 시 (즉시 응답):**
  - HTTP 202 Accepted
  - 응답 본문:
    ```json
    {
      "status": "processing",
      "job_id": "a1b2c3d4-e5f6-7890-abcd-ef1234567890",
      "message": "파일 업로드가 시작되었습니다. 처리가 완료되면 알려드리겠습니다.",
      "estimated_time": "약 30초 소요 예상"
    }
    ```
  - UI 변경:
    - "업로드 중... 데이터를 처리하고 있습니다." 메시지 표시
    - 각 파일별 프로그레스 바 애니메이션 시작
    - 작업 상태 폴링 시작 (3초 간격)

- **실패 시:**
  - **API Key 불일치 (HTTP 403 Forbidden):**
    - 에러 모달: "관리자 권한이 없습니다. 접근이 거부되었습니다."
    - 메인 대시보드로 리디렉션 옵션 제공

  - **파일 검증 실패 (HTTP 400 Bad Request):**
    - 응답 본문 예시:
      ```json
      {
        "error": "validation_error",
        "details": {
          "file": "publication_list.csv",
          "issue": "필수 컬럼 'Impact Factor'가 누락되었습니다.",
          "required_columns": ["논문ID", "학과", "저널등급", "Impact Factor"]
        }
      }
      ```
    - UI: 구체적인 에러 메시지 표시, 해당 파일 하이라이트

  - **서버 에러 (HTTP 500 Internal Server Error):**
    - 에러 토스트: "서버 오류가 발생했습니다. 잠시 후 다시 시도하세요."
    - "재시도" 버튼 표시

#### 엣지케이스
- **네트워크 단절:** 요청 타임아웃 → "네트워크 연결을 확인하세요" 메시지, 자동 재시도 (최대 3회)
- **동시 다중 업로드:** 여러 관리자가 동시에 업로드 시 작업 큐에서 순차 처리 또는 병렬 처리 (서버 리소스에 따라)
- **파일 전송 중 사용자 이탈:** 브라우저 새로고침 또는 페이지 이탈 시 업로드 취소 확인 모달 표시, 백그라운드 처리는 서버에서 계속 진행
- **세션 만료:** 업로드 중 세션 만료 시에도 백그라운드 처리는 계속, `job_id`로 나중에 상태 조회 가능

---

### 2.4 백그라운드 데이터 파싱 (Pandas 로직)

#### 시스템 자동 처리 (사용자 비가시 영역)

#### 처리 (System Processing)

**단계 1: 파일 타입별 파서 선택**
- `excel_parser.py` 모듈의 파일 타입별 전용 파싱 함수 호출:
  - `parse_research_project_data(file_path)` → 연구비 집행 데이터
  - `parse_student_roster(file_path)` → 학생 명단
  - `parse_publication_list(file_path)` → 논문 목록
  - `parse_department_kpi(file_path)` → 학과 KPI

**단계 2: Pandas DataFrame 로드 및 기본 파싱**
- CSV/Excel 파일을 Pandas DataFrame으로 로드:
  - `pd.read_csv()` 또는 `pd.read_excel()` 사용
  - 인코딩 자동 감지 (UTF-8 → EUC-KR → CP949 순서로 시도)
- 헤더 행 자동 감지 및 컬럼명 정규화 (공백 제거, 일관성 확보)

**단계 3: 필수 컬럼 존재 여부 검증**
- PRD 명세에 정의된 필수 컬럼 리스트와 비교
- 예시 (연구비 집행 데이터):
  - 필수: `['집행ID', '소속학과', '총연구비', '집행일자', '집행금액']`
- 누락된 컬럼 발견 시 즉시 예외 발생 → 작업 상태 "failed" 업데이트

**단계 4: 데이터 타입 변환 및 검증**
- 날짜 컬럼 → `datetime` 객체로 변환:
  - `pd.to_datetime(df['집행일자'], errors='coerce')`
  - 변환 실패 시 NaT(Not a Time) 발생 → 해당 행 에러 로그 기록
- 금액/숫자 컬럼 → `int` 또는 `float` 변환:
  - 쉼표 제거: `df['총연구비'].str.replace(',', '')`
  - `pd.to_numeric(df['총연구비'], errors='coerce')`
- 문자열 컬럼 → 양쪽 공백 제거:
  - `df['소속학과'] = df['소속학과'].str.strip()`

**단계 5: 데이터 정제 (Cleaning)**
- **결측값(NaN) 처리:**
  - 필수 컬럼에 NaN 존재 시 해당 행 제외 + 경고 로그 기록
  - 선택적 컬럼(예: Impact Factor)의 NaN은 허용 (NULL로 저장)

- **중복 데이터 감지 및 처리:**
  - PK 컬럼 기준 중복 검사 (예: 학번, 논문ID, 집행ID)
  - 중복 발견 시 전략:
    - MVP: 마지막 행 유지 (`df.drop_duplicates(subset=['PK컬럼'], keep='last')`)
    - 경고 로그 기록: "중복 데이터 X건 발견, 최신 데이터로 유지"

- **데이터 범위 검증:**
  - 학년: 1~4 (학사) 또는 1~2 (석사) 또는 1~4 (박사)
  - 날짜: 미래 날짜 불허 (현재 날짜 이전만 허용)
  - 금액: 음수 불허 (0 이상)
  - 비율 (취업률): 0~100% 범위
- 범위 위반 데이터 발견 시:
  - 해당 행 제외 + 상세 에러 로그 (행 번호, 컬럼, 값 포함)

**단계 6: 비즈니스 로직 검증**
- 연구비 집행 데이터: `집행금액 <= 총연구비` 검증
- 학생 명단: `학적상태`가 허용된 값 중 하나인지 검증 (재학/휴학/졸업)
- 논문 목록: `저널등급`이 정의된 등급 목록에 포함되는지 검증 (SCIE/KCI/...)

**단계 7: 최종 DataFrame 반환**
- 정제 완료된 DataFrame 반환
- 파싱 통계 정보 생성:
  - 총 행 수
  - 유효 행 수
  - 제외된 행 수
  - 경고/에러 로그

#### 출력 (Internal)
- **성공:** 정제된 DataFrame 객체 + 파싱 통계
- **실패:** 예외 발생 (`ValidationError`, `ParsingError` 등) + 상세 에러 메시지

#### 엣지케이스
- **파싱 중 메모리 부족:** 파일을 청크(chunk) 단위로 분할 처리 (예: 1000행씩)
- **인코딩 감지 실패:** 모든 인코딩 시도 실패 시 "파일 인코딩을 감지할 수 없습니다" 에러 반환
- **완전히 비어있는 DataFrame (헤더만 존재):** "데이터 행이 없습니다" 에러 반환
- **극단적으로 큰 파일 (10MB 이하지만 수십만 행):** 타임아웃 방지를 위해 청크 처리 또는 샘플링 (MVP 이후 고려)

---

### 2.5 데이터베이스 저장 (Repositories 레이어)

#### 처리 (System Processing)

**단계 1: Repository 함수 호출**
- `repositories.py`의 Bulk Insert 함수 호출
- 예시: `save_research_funding_data(dataframe, replace=True)`

**단계 2: 데이터 저장 전략 (MVP: 전체 교체만)**
- 기존 동일 타입 데이터 전체 삭제 (`DELETE FROM research_projects`)
- 신규 데이터 Bulk Insert
- `[POST-MVP]` 증분 업데이트 모드 (UPSERT)

**단계 3: 트랜잭션 처리**
- Django ORM 트랜잭션 시작:
  ```python
  from django.db import transaction

  with transaction.atomic():
      # 기존 데이터 삭제
      ResearchProject.objects.all().delete()
      # Bulk Insert
      ResearchProject.objects.bulk_create([
          ResearchProject(**row) for row in dataframe.to_dict('records')
      ])
  ```
- **원자성 보장:** 모든 삽입 성공 시 COMMIT, 하나라도 실패 시 ROLLBACK

**단계 4: 저장 결과 검증**
- 삽입된 행 수 확인
- 예상 행 수와 실제 삽입 행 수 비교
- 불일치 시 경고 로그 기록

**단계 5: 작업 상태 업데이트**
- 작업 ID에 대한 상태를 `"completed"` 또는 `"failed"`로 업데이트
- 성공 시 메타데이터 저장:
  - 처리된 행 수
  - 삽입된 행 수
  - 처리 소요 시간
- 실패 시 에러 정보 저장:
  - 에러 타입
  - 에러 메시지
  - 스택 트레이스 (관리자용)

#### 출력 (Internal)
- **성공:** 데이터베이스에 정제된 데이터 저장 완료, 작업 상태 `"completed"`
- **실패:** 트랜잭션 롤백, 작업 상태 `"failed"`, 에러 로그 저장

#### 엣지케이스
- **DB 연결 실패:** 재시도 로직 (지수 백오프, 최대 3회), 모두 실패 시 에러 상태로 표시
- **DB 저장 공간 부족:** "데이터베이스 용량이 부족합니다" 구체적 에러 메시지 반환
- **중복 PK 충돌 (전체 교체 모드 아닐 경우):** 기존 레코드 UPDATE 또는 건너뛰기 (로그 기록)
- **외래 키 제약 위반:** 관련 데이터 누락 시 에러 메시지와 함께 실패 처리
- **트랜잭션 타임아웃:** 대용량 데이터 삽입 시 타임아웃 발생 가능 → 배치 크기 조정 (1000건씩 분할 삽입)

---

### 2.6 업로드 상태 확인 및 사용자 피드백

#### 입력 (User Input)
- 자동 폴링: 프런트엔드에서 3초 간격으로 작업 상태 조회 API 호출
- 수동 확인: "상태 새로고침" 버튼 클릭 (선택적)

#### 처리 (System Processing)

**단계 1: 상태 조회 API 호출**
- `GET /api/upload/status/<job_id>/` 엔드포인트 호출
- 백엔드에서 작업 ID에 해당하는 현재 상태 조회

**단계 2: 상태 응답 구조**
```json
{
  "job_id": "a1b2c3d4-e5f6-7890-abcd-ef1234567890",
  "status": "completed",  // 또는 "processing", "failed"
  "progress": 100,  // 0~100
  "files": [
    {
      "file_type": "research_funding",
      "status": "completed",
      "rows_processed": 1523,
      "rows_inserted": 1498,
      "rows_skipped": 25,
      "errors": []
    },
    {
      "file_type": "students",
      "status": "failed",
      "error_message": "필수 컬럼 '학과'가 누락되었습니다.",
      "error_details": "3번째 행부터 '학과' 컬럼 값이 비어있습니다."
    }
  ],
  "completed_at": "2025-11-02T14:35:22Z"
}
```

**단계 3: 프런트엔드 상태 처리 분기**
- **`processing` 상태:** 폴링 계속, 프로그레스 바 업데이트
- **`completed` 상태:** 폴링 중단, 성공 UI 표시
- **`failed` 상태:** 폴링 중단, 에러 UI 표시

#### 출력 (User Feedback)
- **처리 중 (processing):**
  - UI 요소:
    - 각 파일별 프로그레스 바 (진행률 표시)
    - "데이터 처리 중... (약 XX초 소요)"
    - 진행 중인 파일명 하이라이트
  - 사용자는 다른 페이지로 이동 가능 (백그라운드 처리 계속)

- **완료 (completed):**
  - UI 요소:
    - 녹색 체크 아이콘
    - "업로드가 완료되었습니다!"
    - 세부 통계:
      - "총 X개 파일 중 Y개 성공"
      - "총 XXX건의 데이터가 등록되었습니다."
      - "처리 시간: X분 Y초"
  - 액션 버튼:
    - "대시보드 보기" → 메인 대시보드로 이동하여 업데이트된 데이터 확인
    - "추가 업로드" → 업로드 페이지 초기화

- **실패 (failed):**
  - UI 요소:
    - 빨간색 경고 아이콘
    - "업로드 중 오류가 발생했습니다."
    - 파일별 상세 에러 메시지:
      - "student_roster.csv 처리 실패"
      - "원인: 3번째 행에서 '학과' 컬럼이 비어있습니다."
      - "권장 조치: Excel에서 해당 행을 수정한 후 다시 업로드하세요."
  - 액션 버튼:
    - "다시 시도" → 파일 재선택 화면으로 이동
    - `[POST-MVP]` 에러 로그 다운로드
    - `[POST-MVP]` 부분 성공 처리

#### 엣지케이스
- **폴링 중 네트워크 단절:**
  - 3회 연속 실패 시 "네트워크 연결을 확인하세요" 경고
  - 재연결 시 자동으로 폴링 재개

- **장시간 처리 (3분 이상):**
  - 경고 메시지: "처리 시간이 예상보다 길어지고 있습니다. 파일 크기가 크거나 복잡한 데이터일 수 있습니다."
  - 추정 완료 시간 표시 (가능한 경우)

- **작업 ID 만료 또는 없음:**
  - "작업 정보를 찾을 수 없습니다." 메시지
  - "새로 업로드하기" 버튼

- **`[POST-MVP]` 부분 성공 처리:**
  - MVP에서는 전체 성공/실패만 처리

---

## 3. 메인 대시보드 조회 플로우

### 플로우 개요
내부 직원이 메인 대시보드에 접속하여 4가지 핵심 지표를 시각화된 차트로 조회하는 과정

### 진입점
- 루트 URL `/` 또는 `/dashboard` 직접 접속
- 데이터 업로드 완료 후 "대시보드 보기" 버튼 클릭
- 북마크 또는 공유된 링크

---

### 3.1 대시보드 초기 로드

#### 입력 (User Input)
- 브라우저에서 메인 대시보드 URL 접속
- HTTP GET 요청 자동 전송

#### 처리 (System Processing)

**단계 1: 프런트엔드 애플리케이션 초기화**
- React 앱 번들 로드
- 메인 대시보드 컴포넌트 렌더링 시작
- 초기 필터 상태 설정 (기본값: "전체 학과", "최근 1년")
- 스켈레톤 UI 표시 (로딩 중 임시 레이아웃)

**단계 2: 초기 데이터 요청 (병렬 처리)**
- `useDashboardData.js` Hook에서 4개의 API 요청 동시 전송:
  1. `GET /api/dashboard/research-funding/?department=all&year=latest`
  2. `GET /api/dashboard/students/?department=all&status=all`
  3. `GET /api/dashboard/publications/?department=all&year=latest`
  4. `GET /api/dashboard/department-kpi/?year=latest`
- 각 요청은 독립적으로 처리 (하나 실패해도 나머지 표시)

**단계 3: 백엔드 데이터 집계**
- DRF View에서 Django ORM을 통해 Supabase 쿼리
- 각 지표별 집계 로직:
  - **연구비:**
    - 최신 잔액: `총연구비 - SUM(집행금액)`
    - 월별 집행 추이: GROUP BY 집행일자 (월 단위)
  - **학생:**
    - 학과별 그룹화: GROUP BY 학과, 과정구분, 학년
    - 학적상태 필터링 (재학/휴학/졸업)
  - **논문:**
    - 저널 등급별 카운트: GROUP BY 저널등급
    - 평균 Impact Factor: AVG(Impact Factor WHERE NOT NULL)
  - **KPI:**
    - 년도별 추이: GROUP BY 평가년도
    - 취업률 및 기술이전 수입액
- JSON 형태로 응답 반환

**단계 4: 프런트엔드 데이터 처리 및 렌더링**
- API 응답 데이터를 Chart 컴포넌트에 맞는 형식으로 변환
- Recharts 라이브러리에 데이터 바인딩
- 4개의 차트 영역 순차 렌더링

#### 출력 (User Feedback)
- **성공 시:**
  - **페이지 레이아웃:**
    - 상단: 페이지 제목 "대학교 데이터 시각화 대시보드"
    - 우측 상단: 필터 드롭다운 (학과, 기간)
    - 최종 업데이트 시간 표시: "마지막 업데이트: 2025-11-02 14:35"

  - **4개 지표 카드 (상단 행):**
    - 연구비 잔액 카드: "총 연구비 잔액: 15억 3천만원"
    - 재학생 수 카드: "총 재학생: 1,234명"
    - 논문 수 카드: "총 논문: 156편 (평균 IF: 2.3)"
    - 평균 취업률 카드: "평균 취업률: 78.5%"
    - 각 카드에 전년 대비 증감 아이콘 (↑/↓) 및 백분율

  - **4개 핵심 차트 (그리드 레이아웃):**
    1. 연구비 집행 추이 (Line Chart)
    2. 학과별 학생 현황 (Stacked Bar Chart)
    3. 논문 실적 (Doughnut Chart)
    4. 학과 KPI 추이 (Dual-axis Line Chart)

- **실패 시:**
  - **데이터 없음 (DB에 데이터 미존재):**
    - 빈 상태 일러스트레이션 표시
    - 메시지: "아직 등록된 데이터가 없습니다."
    - 설명: "관리자가 데이터를 업로드하면 여기에 시각화가 표시됩니다."
    - 액션: (관리자 권한 있을 경우) "첫 데이터 업로드하기" 버튼

  - **API 에러 (서버 장애 등):**
    - 에러 상태 일러스트레이션
    - 메시지: "데이터를 불러오는 중 문제가 발생했습니다."
    - 액션: "새로고침" 버튼

#### 엣지케이스
- **네트워크 느림:**
  - 타임아웃: 30초
  - 스켈레톤 UI 유지
  - 30초 초과 시 "데이터 로딩이 지연되고 있습니다" 경고 표시

- **부분 데이터 로드 실패:**
  - 성공한 차트는 정상 표시
  - 실패한 차트 영역에 에러 카드 표시:
    - "이 데이터를 불러올 수 없습니다."
    - "재시도" 버튼 (해당 차트만 다시 로드)

- **브라우저 호환성:**
  - 구형 브라우저 감지 시 경고 배너 표시
  - "최신 Chrome, Firefox, Edge 브라우저 사용을 권장합니다."
  - 차트 렌더링 실패 시 대체 테이블 뷰 제공

- **첫 방문 사용자 (캐시 없음):**
  - 초기 로딩 시간 더 소요 가능
  - "초기 로딩 중..." 메시지 표시
  - 로딩 완료 후 캐싱하여 재방문 시 빠른 로드

---

### 3.2 차트별 데이터 표시 세부 사항

#### 3.2.1 연구비 집행 추이 (Line Chart)

**시각화 요소:**
- **차트 타입:** Line Chart (Recharts `<LineChart>`)
- **X축:** 집행 일자 (월별 또는 분기별 집계)
- **Y축:** 누적 잔액 또는 집행 금액 (억원 단위)
- **라인:** 파란색 실선, 데이터 포인트에 점 마커
- **그리드:** 수평 그리드 라인 (시인성 향상)

**상단 Metric Card:**
- "현재 연구비 잔액: 15.3억원"
- 전년 대비 증감: "+2.1억원 (↑ 15.8%)"

**인터랙션:**
- 호버 시 Tooltip 표시:
  - "2024년 3월: 잔액 15.3억원, 집행 1.2억원"

**엣지케이스:**
- **데이터 포인트 1개:** 단일 점만 표시, "추가 데이터 업로드 시 추이를 확인할 수 있습니다" 안내
- **급격한 변화 (이상치):** 해당 포인트 강조 표시, 관리자에게 알림 (선택적)

---

#### 3.2.2 학과별 학생 현황 (Stacked Bar Chart)

**시각화 요소:**
- **차트 타입:** Stacked Bar Chart (Recharts `<BarChart>`)
- **X축:** 학과명 (가로 스크롤 가능)
- **Y축:** 학생 수
- **스택:** 과정별 (학사/석사/박사) 또는 학년별
- **색상:** 과정별로 구분된 색상 팔레트

**범례:**
- 과정 구분 표시 (학사: 파랑, 석사: 초록, 박사: 주황)

**인터랙션:**
- 호버 시 Tooltip:
  - "컴퓨터공학과"
  - "학사: 120명, 석사: 35명, 박사: 12명"
  - "총: 167명"

**엣지케이스:**
- **학과 수 많음 (10개 이상):**
  - 차트 넓이 자동 확장
  - 가로 스크롤 바 표시
  - 또는 페이지네이션 (상위 10개 학과 우선 표시)

- **특정 학과 데이터 없음:** 해당 학과 바 표시하지 않거나 0으로 표시

---

#### 3.2.3 논문 실적 (Doughnut Chart)

**시각화 요소:**
- **차트 타입:** Doughnut Chart (Recharts `<PieChart>` with innerRadius)
- **섹션:** 저널 등급별 (SCIE, KCI, 기타)
- **값:** 논문 수
- **색상:** 등급별 구분 (SCIE: 진한 파랑, KCI: 연한 파랑)

**중앙 Metric:**
- "총 논문 수: 156편"

**상단 Metric Card:**
- "평균 Impact Factor: 2.3"

**인터랙션:**
- 호버 시 Tooltip:
  - "SCIE: 89편 (57.1%)"
  - "평균 IF: 3.2"

**엣지케이스:**
- **단일 등급만 존재:** 전체 도넛이 하나의 색상, 100% 표시
- **Impact Factor 없는 논문:** 평균 계산 시 제외, 또는 "IF 정보 없음" 별도 표시

---

#### 3.2.4 학과 KPI 추이 (Dual-axis Line Chart)

**시각화 요소:**
- **차트 타입:** Line Chart with Dual Y-Axis
- **X축:** 평가 년도
- **Y축 (왼쪽):** 취업률 (%)
- **Y축 (오른쪽):** 기술이전 수입액 (억원)
- **라인:**
  - 취업률: 실선, 파란색
  - 수입액: 점선, 주황색

**범례:**
- "졸업생 취업률", "기술이전 수입액"

**인터랙션:**
- 호버 시 Tooltip:
  - "2023년"
  - "취업률: 78.5%"
  - "수입액: 12.3억원"

**엣지케이스:**
- **년도 데이터 누락:** 해당 년도에서 라인 끊김 또는 점선으로 연결
- **음수 값:** 발생하지 않아야 하지만, 발생 시 에러 로그 기록 및 0으로 처리

---

## 4. 대시보드 필터링 플로우

### 플로우 개요
사용자가 학과, 기간 등 필터 조건을 선택하여 특정 데이터만 조회하는 과정

### 진입점
- 메인 대시보드에서 필터 드롭다운 또는 필터 패널 접근

---

### 4.1 필터 조건 선택

#### 입력 (User Input)
- **학과 필터:** 드롭다운에서 학과 선택
  - 옵션: "전체 학과", "컴퓨터공학과", "전자공학과", ...
- **기간 필터:** 드롭다운에서 기간 선택
  - 옵션: "최근 1년", "최근 3년", "2024년", "2023년", ...
- **학적상태 필터 (학생 차트 전용, 선택적):**
  - 라디오 버튼: "전체", "재학", "졸업"
- **저널등급 필터 (논문 차트 전용, 선택적):**
  - 체크박스: "SCIE", "KCI", "전체"

#### 처리 (System Processing)

**단계 1: 프런트엔드 필터 상태 업데이트**
- React State에 선택된 필터 값 저장
- `[P1-MVP]` 간단한 디바운싱 (300ms)

**단계 2: `[POST-MVP]` URL 쿼리 파라미터 업데이트 (공유 링크)**
- MVP에서는 생략, 필터 상태는 세션 내에서만 유지

**단계 3: 필터링된 데이터 API 요청**
- 선택된 필터 조건을 쿼리 파라미터로 포함하여 API 재호출:
  - `GET /api/dashboard/research-funding/?department=컴퓨터공학과&year=2024`
  - `GET /api/dashboard/students/?department=컴퓨터공학과&status=enrolled`
  - 기타 차트도 동일

**단계 4: 백엔드 필터링 쿼리 실행**
- Django ORM에서 WHERE 절 추가:
  ```python
  queryset = ResearchProject.objects.filter(
      소속학과='컴퓨터공학과',
      집행일자__year=2024
  )
  ```
- 필터링된 데이터 집계 및 JSON 응답

**단계 5: 차트 리렌더링**
- 프런트엔드에서 새로운 데이터로 차트 업데이트
- Recharts 애니메이션 효과 (부드러운 전환)
- 로딩 스피너는 짧게 표시 (1초 미만)

#### 출력 (User Feedback)
- **성공 시:**
  - 차트가 필터 조건에 맞게 업데이트됨
  - 필터 드롭다운에 선택된 값 표시
  - 필터 초기화 버튼 활성화: "전체 보기"
  - `[POST-MVP]` 필터 칩/태그 UI (X 버튼으로 개별 제거)

- **필터 결과 없음:**
  - 차트 영역에 빈 상태 표시
  - 메시지: "선택한 조건에 해당하는 데이터가 없습니다."
  - 추천: "다른 필터 조건을 선택하거나 '전체 보기'를 클릭하세요."
  - 필터 초기화 버튼 강조

- **API 에러:**
  - 기존 차트 유지 (마지막 성공 데이터)
  - 에러 토스트 알림: "필터 적용 중 오류가 발생했습니다. 다시 시도하세요."

#### 엣지케이스
- **다중 필터 조합:**
  - 학과 + 기간 + 학적상태 동시 적용 시 AND 조건으로 처리
  - 필터 조합이 너무 좁아 결과 없을 경우 위 "필터 결과 없음" 처리

- **필터 빠른 변경:**
  - 디바운싱으로 불필요한 API 호출 방지
  - 사용자가 드롭다운에서 여러 옵션을 빠르게 클릭해도 마지막 선택만 적용

- **잘못된 필터 값 (URL 직접 수정 등):**
  - 백엔드에서 400 Bad Request 반환
  - 프런트엔드에서 필터 초기화 및 에러 토스트 표시

- **필터 적용 중 새로고침:**
  - URL 쿼리 파라미터에서 필터 상태 복원
  - 동일한 필터 조건으로 데이터 재로드

---

### 4.2 필터 초기화 `[P1-MVP]`

#### 입력 (User Input)
- "전체 보기" 또는 "초기화" 버튼 클릭

#### 처리 (System Processing)
- 모든 필터 상태를 기본값으로 리셋:
  - 학과: "전체 학과"
  - 기간: "최근 1년"
  - 기타: 기본값
- URL 쿼리 파라미터 제거
- 기본 필터 조건으로 API 재호출

#### 출력 (User Feedback)
- 차트가 전체 데이터로 복원됨
- 필터 드롭다운이 기본값으로 리셋
- "전체 보기" 버튼 비활성화

**[POST-MVP]** URL 기반 필터 공유 기능

---

## 5. 차트 인터랙션 플로우 `[P1-MVP]`

### 플로우 개요
MVP에서는 **기본 Tooltip만 구현**합니다. 확대/축소, 드릴다운, 내보내기 등 고급 기능은 POST-MVP로 미룹니다.

---

### 5.1 차트 요소 호버 (Tooltip) `[P1-MVP]`

#### 입력 (User Input)
- 마우스 커서를 차트의 데이터 포인트, 바, 섹션 등에 올림

#### 처리 (System Processing)
- Recharts의 기본 Tooltip 컴포넌트 활성화
- 해당 데이터 포인트의 상세 정보 추출
- 커스텀 Tooltip 템플릿에 데이터 바인딩

#### 출력 (User Feedback)
- 커서 근처에 Tooltip 팝업 표시
- **내용 예시:**
  - **연구비 차트:** "2024년 3월: 집행 1.2억원, 잔액 15.3억원"
  - **학생 차트:** "컴퓨터공학과 - 학사 3학년: 42명"
  - **논문 차트:** "SCIE: 89편 (57.1%), 평균 IF: 3.2"
  - **KPI 차트:** "2023년 - 취업률: 78.5%, 수입액: 12.3억원"
- 커서 이동 시 Tooltip 자동 업데이트
- 커서가 차트 밖으로 나가면 Tooltip 사라짐

#### 엣지케이스
- **모바일 터치:**
  - 데이터 포인트 탭하여 Tooltip 고정 표시
  - 다른 곳 탭하면 사라짐

- **Tooltip 겹침:**
  - 여러 데이터 포인트가 근접한 경우 가장 가까운 것만 표시

- **긴 텍스트:**
  - Tooltip 최대 너비 설정
  - 긴 텍스트는 줄바꿈 처리

**[POST-MVP 고급 기능]**
- 차트 확대/축소 (Zoom, Brush)
- 차트 클릭 드릴다운 (필터 자동 적용)
- 차트 데이터 내보내기 (CSV/PNG/PDF)

---

## 6. 데이터 갱신 플로우 `[P1-MVP]`

### 플로우 개요
MVP에서는 **수동 새로고침만 구현**합니다. 자동 폴링, 변경 비교 등은 POST-MVP 기능입니다.

---

### 6.1 수동 새로고침 `[P1-MVP]`

#### 입력 (User Input)
- 대시보드 헤더의 "새로고침" 버튼 클릭
- 또는 브라우저 새로고침 (F5, Cmd+R)

#### 처리 (System Processing)
- 프런트엔드 캐시된 데이터 클리어
- 현재 필터 조건으로 모든 차트 데이터 재요청
- API 호출 → 백엔드에서 최신 DB 데이터 조회 → 응답

#### 출력 (User Feedback)
- 로딩 인디케이터 표시 (스피너 또는 스켈레톤 UI)
- 데이터 로드 완료 시 차트 업데이트
- "데이터가 갱신되었습니다" 토스트 알림 (짧게 표시)

#### 엣지케이스
- **빠른 연속 새로고침:** 1초 이내 중복 클릭 무시 (간단한 디바운싱)

**[POST-MVP 고급 기능]**
- 자동 갱신 (30초 간격 폴링)
- 데이터 업데이트 타임스탬프 표시
- 이전 데이터와 비교 (스냅샷 기반)

---

## 7. 에러 처리 플로우 `[P0-MVP]`

### 플로우 개요
MVP에서는 **핵심 에러만 처리**합니다. 복잡한 에러 로깅, 자동 재시도, 감사 추적 등은 제외합니다.

---

### 7.1 파일 업로드 검증 에러 `[P0-MVP]`

#### 발생 시나리오
- 파일 크기 초과 (>10MB)
- 잘못된 파일 형식 (.pdf, .doc 등)
- 필수 컬럼 누락
- 데이터 타입 불일치
- 중복 PK

#### 처리 (System Processing)
- 프런트엔드 또는 백엔드 검증 단계에서 에러 감지
- 구체적인 에러 메시지 생성 (에러 타입, 파일명, 위반 규칙, 권장 조치)

#### 출력 (User Feedback)
- 에러 알림 표시:
  - **크기 초과:** "파일 'student_roster.xlsx'의 크기가 12.3MB로 제한(10MB)을 초과합니다. 데이터를 분할하거나 불필요한 행을 제거하세요."
  - **컬럼 누락:** "'research_project_data.csv'에서 필수 컬럼 [집행ID, 소속학과]가 누락되었습니다. Ecount 추출 시 모든 필수 컬럼이 포함되었는지 확인하세요."
  - **데이터 타입 오류:** "'publication_list.csv' 45번째 행의 'Impact Factor' 컬럼에 숫자가 아닌 값('N/A')이 있습니다. 숫자 또는 빈 칸으로 수정하세요."
- 에러가 발생한 파일 강조 표시
- "파일 다시 선택" 버튼

#### 복구 플로우
- 사용자가 파일 수정 후 재업로드

#### 엣지케이스
- **다중 에러:** 최대 5개까지 에러 메시지 표시, 초과 시 "외 X개 에러" 요약

---

### 7.2 데이터 처리 실패 (Parsing/DB 에러) `[P0-MVP]`

#### 발생 시나리오
- Pandas 파싱 예외 (손상된 CSV)
- 데이터베이스 트랜잭션 롤백
- 처리 타임아웃
- 메모리 부족

#### 처리 (System Processing)
- `excel_parser.py` 또는 `repositories.py`에서 예외 발생
- 작업 상태를 `"failed"`로 업데이트
- 기본 에러 메시지 생성

#### 출력 (User Feedback)
- 폴링 응답에서 `"failed"` 상태 감지
- 에러 알림 표시:
  - "데이터 처리 중 오류가 발생했습니다."
  - "'student_roster.csv' 파싱 실패"
  - "파일 형식을 확인하고 다시 시도하세요."
- "다시 시도" 버튼

---

### 7.3 API 연결 에러 `[P0-MVP]`

#### 발생 시나리오
- 백엔드 서버 다운
- 네트워크 타임아웃

#### 처리 (System Processing)
- 네트워크 에러 감지
- 간단한 재시도 (1회만)

#### 출력 (User Feedback)
- 에러 메시지:
  - "서버에 연결할 수 없습니다."
  - "네트워크 연결을 확인하세요."
- "재시도" 버튼

#### 복구 플로우
- 사용자가 "재시도" 버튼 클릭
- 실패한 API 요청 재실행

---

### 7.4 차트 렌더링 에러 `[P1-MVP]`

#### 발생 시나리오
- Recharts 렌더링 예외
- 차트 데이터 부족

#### 처리 (System Processing)
- React Error Boundary로 렌더링 에러 캐치
- 간단한 에러 메시지 표시

#### 출력 (User Feedback)
- 에러 메시지: "차트를 표시할 수 없습니다."
- "새로고침" 버튼

---

### 7.5 권한 부족 (403 Forbidden) `[P0-MVP]`

#### 발생 시나리오
- 비관리자가 업로드 API 접근 시도
- API Key 불일치 또는 만료

#### 처리 (System Processing)
- API Key 검증 실패
- HTTP 403 응답 반환

#### 출력 (User Feedback)
- 에러 메시지: "접근 권한이 없습니다. 관리자 전용 기능입니다."
- 메인 대시보드로 리디렉션

---

## 8. 필수 엣지케이스 `[P1-MVP]`

MVP에서는 **최소한의 엣지케이스만 처리**합니다. 복잡한 시나리오는 POST-MVP로 미룹니다.

---

### 8.1 동시 다중 관리자 업로드 `[P1-MVP]`

**시나리오:** 여러 관리자가 동시에 파일 업로드

**처리 방안:**
- 각 업로드는 독립적인 `job_id`로 관리
- 동일한 파일 타입 업로드 시: Last-Write-Wins (마지막 것만 적용)

**사용자 피드백:**
- 각 관리자는 자신의 업로드 상태만 추적

---

### 8.2 부분 데이터만 업로드된 상태 `[P1-MVP]`

**시나리오:** 4가지 파일 중 일부만 업로드됨

**처리 방안:**
- 존재하는 데이터는 정상 표시
- 없는 데이터 영역은 빈 상태 표시

**사용자 피드백:**
- 빈 차트 영역에 메시지: "논문 데이터가 없습니다. 관리자가 파일을 업로드하면 표시됩니다."

---

### 8.3 데이터 재업로드 (수정) `[P1-MVP]`

**시나리오:** 잘못된 데이터 발견 후 수정본 재업로드

**처리 방안:**
- 전체 교체 모드: 기존 데이터 삭제 후 신규 데이터 삽입

**사용자 피드백:**
- 확인 모달: "기존 데이터를 삭제하고 새 데이터로 교체합니다. 계속하시겠습니까?"
- "교체", "취소" 버튼

---

### 8.4 대용량 데이터 처리 `[P1-MVP]`

**시나리오:** 수천 건 이상의 레코드

**처리 방안:**
- 백엔드에서 기본 제한 (최대 10,000건)
- 초과 시 에러 메시지

**사용자 피드백:**
- "데이터가 너무 많습니다(최대 10,000건). 데이터를 분할하여 업로드하세요."

---

**[POST-MVP 고급 시나리오]**
- 데이터 스키마 버전 관리
- 구형 브라우저 호환성
- 모바일 반응형 최적화
- 오래된 데이터 경고 (30일 기준)
- 세션 타임아웃 복구
- 청크 업로드 재개

---

## MVP 범위 요약

### P0-MVP (필수 구현)
1. **관리자 데이터 업로드**
   - 4가지 CSV/Excel 파일 업로드
   - 기본 파일 검증 (크기, 형식, 필수 컬럼)
   - 비동기 백그라운드 처리
   - 작업 상태 폴링 (3초 간격)

2. **메인 대시보드 조회**
   - 4가지 핵심 차트 (연구비, 학생, 논문, KPI)
   - 기본 지표 카드

3. **필터링**
   - 학과, 기간 드롭다운 필터
   - 필터 초기화

4. **핵심 에러 처리**
   - 파일 업로드 검증 에러
   - 데이터 처리 실패
   - API 연결 에러
   - 권한 부족

### P1-MVP (중요하지만 간소화 가능)
- 차트 기본 Tooltip
- 수동 새로고침
- 간단한 디바운싱
- 기본 엣지케이스 (4개)

### POST-MVP (추후 고도화)
- 차트 확대/축소, 드릴다운, 내보내기
- 자동 갱신 (폴링)
- 데이터 변경 비교
- URL 기반 필터 공유
- 에러 로그 다운로드
- 부분 성공 처리
- 구형 브라우저 호환성
- 모바일 최적화
- 감사 추적

---

## 문서 변경 이력

| 버전 | 날짜 | 변경 사항 | 작성자 |
|------|------|-----------|--------|
| 1.0 | 2025-11-02 | 초기 유저플로우 문서 작성 | Userflow Writer Agent |
| 2.0 | 2025-11-02 | MVP 최적화 (오버엔지니어링 제거, CTO Mandate 반영) | Claude Code |

---

## 승인 및 검토

**작성자:** Userflow Writer Agent / Claude Code
**검토자:** CTO
**승인일:** 2025-11-02

본 유저플로우 문서는 **MVP 범위**에 맞춘 개발 가이드입니다. 첫 베타테스트에 필요한 최소 기능만 구현하며, POST-MVP 기능은 베타 피드백 후 우선순위를 재평가합니다.

**MVP 개발 우선순위:**
1. `[P0-MVP]` 태그 기능: 필수 구현 (블로커)
2. `[P1-MVP]` 태그 기능: 중요하지만 간소화 가능
3. `[POST-MVP]` 태그 기능: 추후 고도화 단계

---

**문서 끝**
